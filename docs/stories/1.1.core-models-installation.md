# Story 1.1: Core Models & Installation

## Status
Completed

## Story
**As a** Framework Developer,
**I want** to create core Catalyst::Agent model using Delegated Types and have the installer generate a default ApplicationAgent type,
**so that** the framework has a persistent, idiomatic, and extensible foundation.

## Acceptance Criteria
1. A catalyst_agents table is created, designed for the Delegated Types pattern.
2. A application_agents table is created to hold the configuration for the default, simple agent type.
3. An executions table is created to track task runs.
4. A Rails generator (rails g catalyst:install) is created that copies migrations and generates the necessary base models and an initializer in the host application's namespace.

## Architectural Context

### The Final Architecture: Namespaced Core with Generated Application Models

This architecture provides the ultimate blend of simplicity and power, perfectly aligning with our goal of creating a framework that feels native to Rails.

* **The Core (in the Gem):** The gem will provide Catalyst::Agent, the base model that contains the delegated_type logic. This keeps the framework's internal machinery cleanly namespaced and encapsulated.
* **The "Simple Path" (Generated in the App):** The installer will generate an ApplicationAgent model directly into the host app's app/ai directory. This model will have the simple role, goal, and backstory fields. It serves as a perfect, out-of-the-box example and is the primary entry point for developers.
* **The "Power-User Path" (Created by the Developer):** For advanced use cases, developers can create their own custom delegated types (e.g., MarketingAgent) and register them in an initializer, following the same pattern as the generated ApplicationAgent.

### Database Schema Design

#### catalyst_agents Table Migration (Base Table)
```ruby
# <timestamp>_create_catalyst_agents.rb
class CreateCatalystAgents < ActiveRecord::Migration[7.1]
  def change
    create_table :catalyst_agents do |t|
      t.string :delegatable_type, null: false
      t.bigint :delegatable_id, null: false
      
      t.integer :max_iterations, default: 1, null: false
      t.bigint :tenant_id, index: true
      
      t.timestamps
    end
    
    add_index :catalyst_agents, [:delegatable_type, :delegatable_id], unique: true, name: 'index_catalyst_agents_on_delegatable'
  end
end
```

#### application_agents Table Migration (For the Simple Path)
```ruby
# <timestamp>_create_application_agents.rb
class CreateApplicationAgents < ActiveRecord::Migration[7.1]
  def change
    create_table :application_agents do |t|
      t.string :role
      t.text :goal
      t.text :backstory
      
      t.timestamps
    end
  end
end
```

#### catalyst_executions Table Migration
```ruby
# <timestamp>_create_catalyst_executions.rb
class CreateCatalystExecutions < ActiveRecord::Migration[7.1]
  def change
    create_table :catalyst_executions do |t|
      t.references :agent, null: false, foreign_key: { to_table: :catalyst_agents }
      t.integer :status, default: 0
      t.text :prompt
      t.text :response
      t.json :tool_calls
      t.json :result
      t.text :error_message
      t.datetime :started_at
      t.datetime :completed_at
      t.json :metadata
      t.timestamps
    end
  end
end
```

### Installation Generator & Generated Files

The catalyst:install generator will create the migrations and the following files in the host app.

#### config/initializers/catalyst.rb (Configuration)
```ruby
# config/initializers/catalyst.rb
Catalyst.configure do |config|
  # Register all agent types here.
  # The ApplicationAgent is registered by default.
  config.register_agent_type "ApplicationAgent"
  
  # Example for a custom agent:
  # config.register_agent_type "MarketingAgent"
end
```

#### app/ai/application_agent.rb (The "Simple Path" Model)
```ruby
# app/ai/application_agent.rb
class ApplicationAgent < ApplicationRecord
  # This model is your default, simple agent type.
  # It has the role, goal, and backstory attributes.
  # You can add shared logic for all "generic" agents here.
end
```

The gem itself will contain the Catalyst::Agent base model, which will dynamically read the registered types from the initializer.

## Tasks / Subtasks

- [x] Create Catalyst::Agent ActiveRecord model with delegated types (AC: 1)
  - [x] Define base Agent model with delegatable_type and delegatable_id
  - [x] Add max_iterations and tenant_id fields
  - [x] Create migration for catalyst_agents table
  - [x] Add delegated_type configuration
- [x] Create ApplicationAgent model for simple path (AC: 2)
  - [x] Define ApplicationAgent with role, goal, backstory attributes
  - [x] Include Catalyst::Agentable module
  - [x] Create migration for application_agents table
- [x] Create Catalyst::Execution ActiveRecord model (AC: 3)
  - [x] Define Execution model attributes (status, prompt, response, etc.)
  - [x] Add status enum with values: pending, running, completed, failed
  - [x] Create migration for catalyst_executions table
  - [x] Add association to Agent model
- [x] Create Rails installation generator (AC: 4)
  - [x] Generate catalyst:install generator class
  - [x] Copy migration files to host application
  - [x] Generate ApplicationAgent model in app/ai/
  - [x] Generate initializer with agent type registration
  - [x] Add generator documentation

## Dev Notes

**Relevant Source Tree info:**
- This is a Rails engine located at `/lib/catalyst/engine.rb`
- Models should be placed in `/app/models/catalyst/`
- Generators should be placed in `/lib/generators/catalyst/`
- Migrations should be placed in `/db/migrate/`

**Important notes:**
- This is the foundational story for the entire framework
- All subsequent stories depend on these core models
- The generator should follow Rails conventions for engine generators
- Models should be namespaced under Catalyst module

### Testing Strategy

**Unit Tests:**
- Create model specs for Catalyst::Agent and Catalyst::Execution
- Validate associations, default values, and basic model-level logic
- Test file location: `/test/models/catalyst/` for models
- Test standards: Follow Rails testing conventions with fixtures
- Testing frameworks: Use Rails minitest framework

**Integration/Generator Test:**
- Create a test that runs the catalyst:install generator within the test/dummy application
- Assert that the migration files are correctly copied into the dummy app's db/migrate directory
- Test file location: `/test/generators/catalyst/` for generators
- Specific requirements: Test model validations, associations, and generator functionality

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-01-08 | 1.1 | Updated with delegated types architecture and completion status | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
- Catalyst::Agent (base model with delegated types)
- ApplicationAgent (simple path implementation)
- Catalyst::Execution (execution tracking)

### Debug Log References
- Git commit: 8036301 - feat: implement core Catalyst models and Rails generator
- Implementation branch: feature/cat-1.1-core-models

### Completion Notes List
- Implemented delegated types architecture instead of simple inheritance
- Created comprehensive migration files for all core tables
- Generated ApplicationAgent as default simple path
- Added tenant_id support for multi-tenancy
- Included comprehensive generator with initializer creation

### File List
- app/models/catalyst/agent.rb
- app/models/catalyst/execution.rb
- app/models/catalyst/agentable.rb
- lib/generators/catalyst/install_generator.rb
- db/migrate/*_create_catalyst_agents.rb
- db/migrate/*_create_application_agents.rb
- db/migrate/*_create_catalyst_executions.rb

## QA Results
*To be populated by QA agent*