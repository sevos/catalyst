# Story 4.2: Implement Secure Context Passing

## Status
Draft

## Story
**As a** Rails Developer,
**I want** to define tool arguments that are securely and automatically populated from a task's context,
**so that** I can safely perform actions without exposing sensitive data to the LLM.

## Acceptance Criteria
1. The `perform_later` method is updated to accept a secure `context:` object.
2. A Tool class can declare both LLM-provided arguments and "context-provided" arguments.
3. The framework automatically and securely maps values from the `context` object to the tool's "context-provided" arguments before execution.
4. The context object and context-provided arguments are never exposed to the LLM.

## Tasks / Subtasks

- [ ] Update perform_later with context parameter (AC: 1)
  - [ ] Add context parameter to perform_later method
  - [ ] Store context securely in execution record
  - [ ] Validate context object structure
- [ ] Enhance Tool class for context arguments (AC: 2)
  - [ ] Add context_arguments method to Tool interface
  - [ ] Distinguish between LLM and context-provided arguments
  - [ ] Update tool schema generation to exclude context arguments
- [ ] Implement secure context mapping (AC: 3)
  - [ ] Create context mapper service
  - [ ] Map context values to tool arguments before execution
  - [ ] Validate context contains required values
- [ ] Ensure context never reaches LLM (AC: 4)
  - [ ] Exclude context from LLM prompts
  - [ ] Validate context arguments are not in tool schemas
  - [ ] Add security checks to prevent context leakage

## Dev Notes

**Relevant Source Tree info:**
- Agent class modifications in `/app/models/catalyst/agent.rb`
- Tool interface updates in `/app/models/catalyst/tool.rb`
- Context mapping service at `/app/services/catalyst/context_mapper.rb`
- Security validation throughout tool execution pipeline

**Important notes:**
- This depends on Story 4.1 (Research Secure Context & MCP Compatibility)
- Critical for production security and sensitive data handling
- Context isolation prevents LLM exposure to sensitive information
- Follows ADR recommendations from Story 4.1

### Testing
- Test file location: `/test/models/catalyst/` for tool tests, `/test/services/catalyst/` for context mapper
- Test standards: Test context isolation, secure mapping, validation
- Testing frameworks: Use Rails minitest with security testing patterns
- Specific requirements: Test context never reaches LLM, secure argument mapping

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*