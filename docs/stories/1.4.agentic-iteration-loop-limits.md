# Story 1.4: Agentic Iteration Loop & Limits

## Status
Draft

## Story
**As a** Rails Developer,
**I want** to configure a `max_iterations` limit for an Agent,
**so that** I can control its reasoning loop and prevent runaway executions or excessive costs.

## Acceptance Criteria
1. An Agent class can be configured with a `max_iterations` attribute, which defaults to 1.
2. When a task is performed, the Agent enters a loop that will not exceed the `max_iterations` limit.
3. Within the loop, the agent's context is updated with information about the current step number and the remaining steps.
4. If the `max_iterations` limit is reached, the loop terminates, and the execution is marked as `completed` with a note indicating the limit was hit.

## Tasks / Subtasks

- [ ] Add max_iterations configuration (AC: 1)
  - [ ] Add max_iterations attribute to Agent class
  - [ ] Set default value to 1
  - [ ] Add validation for positive integer values
- [ ] Implement iteration loop (AC: 2)
  - [ ] Refactor agent execution to use loop structure
  - [ ] Track current iteration count
  - [ ] Enforce max_iterations limit
- [ ] Add iteration context (AC: 3)
  - [ ] Include current step number in agent context
  - [ ] Include remaining steps in agent context
  - [ ] Update system prompt with iteration information
- [ ] Handle iteration limit completion (AC: 4)
  - [ ] Detect when max_iterations is reached
  - [ ] Mark execution as completed with limit note
  - [ ] Store iteration information in execution record

## Dev Notes

**Relevant Source Tree info:**
- Agent class modifications in `/app/models/catalyst/agent.rb`
- Execution logic should track iteration state
- System prompt construction needs iteration context

**Important notes:**
- This builds on Story 1.3 (Default LLM Adapter & Basic Execution)
- The iteration loop enables agentic reasoning patterns
- Cost control is a primary concern for LLM usage
- Default of 1 iteration maintains backward compatibility

### Testing
- Test file location: `/test/models/catalyst/` for agent tests
- Test standards: Test iteration limits, context updates, completion states
- Testing frameworks: Use Rails minitest
- Specific requirements: Test max_iterations enforcement, context inclusion, limit detection

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*