# Story 2.2: Tool Execution Loop

## Status
Draft

## Story
**As a** Framework Developer,
**I want** the agent's execution loop to invoke the `#call` method on the correct registered Tool object,
**so that** the agent can reliably execute decoupled tools.

## Acceptance Criteria
1. The agent's iteration loop parses the LLM's response for a tool call request.
2. The framework finds the matching registered tool object from the agent's configuration.
3. The framework securely invokes the tool's `#call` method with the LLM-provided keyword arguments.
4. The return value from `#call` is passed back into the agent's context for the next iteration.

## Tasks / Subtasks

- [ ] Implement tool call parsing (AC: 1)
  - [ ] Parse LLM response for tool call requests
  - [ ] Extract tool name and arguments from response
  - [ ] Handle multiple tool call formats
- [ ] Add tool lookup mechanism (AC: 2)
  - [ ] Find registered tool by name
  - [ ] Validate tool exists before execution
  - [ ] Handle tool not found errors
- [ ] Implement secure tool execution (AC: 3)
  - [ ] Validate arguments against tool schema
  - [ ] Invoke tool #call method with keyword arguments
  - [ ] Handle tool execution errors gracefully
- [ ] Update agent context (AC: 4)
  - [ ] Capture tool execution results
  - [ ] Add results to agent context for next iteration
  - [ ] Format results for LLM consumption

## Dev Notes

**Relevant Source Tree info:**
- Agent execution loop in `/app/models/catalyst/agent.rb`
- Tool execution service should be at `/app/services/catalyst/tool_executor.rb`
- Tool call parsing might need separate service class

**Important notes:**
- This depends on Story 2.1 (Reusable Tool Definition & Registration)
- Implements the "ReAct" pattern (Reasoning + Acting)
- Secure execution prevents malicious tool usage
- Context updates enable multi-step reasoning

### Testing
- Test file location: `/test/models/catalyst/` for agent tests, `/test/services/catalyst/` for services
- Test standards: Test tool call parsing, execution, error handling
- Testing frameworks: Use Rails minitest
- Specific requirements: Test successful tool execution, error scenarios, context updates

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*