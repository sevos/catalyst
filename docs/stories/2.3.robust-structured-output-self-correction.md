# Story 2.3: Robust Structured Output & Self-Correction

## Status
Draft

## Story
**As a** Rails Developer,
**I want** to specify an `ActiveModel` class as an `output_schema`, and for the agent to automatically attempt to fix its output if it fails validation.

## Acceptance Criteria
1. The `perform_later` and `perform_now` methods accept an `output_schema` argument.
2. When an `output_schema` is provided, the system prompt instructs the LLM to format its final answer as JSON matching the `ActiveModel`'s attributes.
3. The framework attempts to parse the LLM's final response into the `ActiveModel` object.
4. If parsing or validation fails AND the agent has iterations left, the validation error message is passed back to the agent as feedback for its next iteration.
5. If parsing and validation succeed, the validated `ActiveModel` object is the final result of the execution.
6. If parsing or validation fails and the agent is out of iterations, the `Execution` is marked as `failed` with the final validation error.

## Tasks / Subtasks

- [ ] Add output_schema parameter (AC: 1)
  - [ ] Modify perform_later and perform_now to accept output_schema
  - [ ] Store output_schema in execution record
  - [ ] Validate output_schema is ActiveModel class
- [ ] Update system prompt for structured output (AC: 2)
  - [ ] Include JSON format instructions in system prompt
  - [ ] Generate schema from ActiveModel attributes
  - [ ] Specify required output format
- [ ] Implement response parsing (AC: 3)
  - [ ] Parse LLM response as JSON
  - [ ] Create ActiveModel instance from parsed data
  - [ ] Handle parsing errors gracefully
- [ ] Add validation and self-correction (AC: 4)
  - [ ] Validate ActiveModel instance
  - [ ] Pass validation errors back to agent if iterations remain
  - [ ] Continue iteration loop with validation feedback
- [ ] Handle successful validation (AC: 5)
  - [ ] Store validated ActiveModel as final result
  - [ ] Mark execution as completed
  - [ ] Return structured result to caller
- [ ] Handle final validation failure (AC: 6)
  - [ ] Mark execution as failed when iterations exhausted
  - [ ] Store validation error in execution record
  - [ ] Log failure details for debugging

## Dev Notes

**Relevant Source Tree info:**
- Agent execution modifications in `/app/models/catalyst/agent.rb`
- Output validation service at `/app/services/catalyst/output_validator.rb`
- JSON parsing and validation logic needs error handling

**Important notes:**
- This depends on Story 2.2 (Tool Execution Loop)
- Structured output enables reliable data extraction
- Self-correction improves output quality
- ActiveModel validation provides robust data validation

### Testing
- Test file location: `/test/models/catalyst/` for agent tests, `/test/services/catalyst/` for validation
- Test standards: Test structured output, validation, self-correction
- Testing frameworks: Use Rails minitest with ActiveModel test fixtures
- Specific requirements: Test successful validation, validation failures, iteration limits

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*