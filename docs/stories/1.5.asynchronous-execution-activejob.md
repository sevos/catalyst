# Story 1.5: Asynchronous Execution via ActiveJob

## Status
Draft

## Story
**As a** Rails Developer,
**I want** to trigger an agent task asynchronously with `perform_later`,
**so that** it doesn't block my application's main thread.

## Acceptance Criteria
1. A generic `Catalyst::ExecutionJob` is created to handle agent tasks.
2. Calling `MyAgent.perform_later("my prompt")` successfully enqueues this job.
3. The job executes the LLM call as defined in Story 1.3.
4. The corresponding `Execution` record's status is correctly updated throughout the job's lifecycle.
5. A `MyAgent.perform_now("my prompt")` method is also available for synchronous execution.

## Tasks / Subtasks

- [ ] Create ExecutionJob class (AC: 1)
  - [ ] Generate Catalyst::ExecutionJob ActiveJob class
  - [ ] Add job logic to execute agent tasks
  - [ ] Handle job parameters (agent_class, prompt)
- [ ] Implement perform_later method (AC: 2)
  - [ ] Add perform_later class method to Agent
  - [ ] Enqueue ExecutionJob with proper parameters
  - [ ] Return job instance for tracking
- [ ] Execute LLM call in job (AC: 3)
  - [ ] Call agent execution logic from job
  - [ ] Maintain same execution flow as Story 1.3
  - [ ] Handle job-specific error scenarios
- [ ] Update execution status (AC: 4)
  - [ ] Set status to 'pending' when job enqueued
  - [ ] Update to 'running' when job starts
  - [ ] Update to 'completed' or 'failed' when job finishes
- [ ] Add perform_now method (AC: 5)
  - [ ] Add perform_now class method to Agent
  - [ ] Execute agent synchronously
  - [ ] Maintain same execution flow but skip job queue

## Dev Notes

**Relevant Source Tree info:**
- ExecutionJob should be at `/app/jobs/catalyst/execution_job.rb`
- Agent class modifications in `/app/models/catalyst/agent.rb`
- Job should follow Rails ActiveJob conventions

**Important notes:**
- This depends on Story 1.4 (Agentic Iteration Loop & Limits)
- Asynchronous execution is crucial for production use
- Status tracking provides visibility into job progress
- Both sync and async methods provide flexibility

### Testing
- Test file location: `/test/jobs/catalyst/` for job tests, `/test/models/catalyst/` for agent tests
- Test standards: Test job enqueueing, execution, status updates
- Testing frameworks: Use Rails ActiveJob testing utilities
- Specific requirements: Test both perform_later and perform_now, status transitions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*